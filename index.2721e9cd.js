function e(e){return e&&e.__esModule?e.default:e}function r(e,r,t,o){Object.defineProperty(e,r,{get:t,set:o,enumerable:!0,configurable:!0})}let t,o;function n(e){return new Promise((function(r,t){let o=new Image;o.crossOrigin="anonymous",o.onload=function(){return r(o)},o.onerror=function(){return t(new Error(`Can't load image ${e}`))},o.src=e}))}function i(e,r){return Object.fromEntries(Object.entries(e).map((([e,t])=>[e,r(t,e)])))}function a(e){const r=Object.entries(e);return Promise.all(r.map((([e,r])=>r)).map(n)).then((e=>Object.fromEntries(e.map(((e,t)=>[r[t][0],e])))))}function s(e){return fetch(e).then((e=>e.text()))}function u(e){const r=Object.entries(e);return Promise.all(r.map((([e,r])=>r)).map(s)).then((e=>Object.fromEntries(e.map(((e,t)=>[r[t][0],e])))))}function c(e,r,t){const o=t.has(e),n=t.get(e);switch(typeof r){case"string":return o?n:r;case"number":return o?Number(n):r;case"boolean":return o?"false"!==n:r;default:throw new Error(`type ${typeof r} does not supported`)}}!function(e){function r(e=0,r=1){return Math.random()*(r-e)+e}function t(){return Math.random()>.5?1:-1}e.range=r,e.signed=function(e=1,o=0){return t()*r(o,e)},e.sign=t}(t||(t={})),function(e){e.Cross=function(e,r){return[e[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]},e.Substract=function(e,r){return[e[0]-r[0],e[1]-r[1],e[2]-r[2]]},e.Normilize=function(e,r=1,t=1e-8){const o=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return o<t?[0,0,0]:[e[0]/o*r,e[1]/o*r,e[2]/o*r]}}(o||(o={}));class l{constructor(e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]){if(16!==e.length)throw new Error("Matrix should be 4x4");this.m=new Float32Array(e)}static Identity(){return new l([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}static Scale(e,r=e,t=e){return new l([e,0,0,0,0,r,0,0,0,0,t,0,0,0,0,1])}static RotateX(e){const r=Math.cos(e),t=Math.sin(e);return new l([1,0,0,0,0,+r,+t,0,0,-t,+r,0,0,0,0,1])}static RotateY(e){const r=Math.cos(e),t=Math.sin(e);return new l([+r,0,-t,0,0,1,0,0,+t,0,+r,0,0,0,0,1])}static RotateZ(e){const r=Math.cos(e),t=Math.sin(e);return new l([+r,+t,0,0,-t,+r,0,0,0,0,1,0,0,0,0,1])}static Perspective(e,r,t,o){const n=Math.tan(.5*(Math.PI-e)),i=1/(t-o);return new l([n/r,0,0,0,0,n,0,0,0,0,(t+o)*i,-1,0,0,t*o*i*2,0])}static Ortographic(e,r,t,o,n,i){const a=r-e,s=o-t,u=i-n;return new l([2/a,0,0,0,0,2/s,0,0,0,0,2/u,0,(e+r)/a,(t+o)/s,(n+i)/u,1])}static LookAt(e,r,t){const n=o.Normilize(o.Substract(e,r)),i=o.Normilize(o.Cross(t,n)),a=o.Normilize(o.Cross(n,i));return new l([i[0],i[1],i[2],0,a[0],a[1],a[2],0,n[0],n[1],n[2],0,e[0],e[1],e[2],1])}static Move(e,r,t){return new l([1,0,0,0,0,1,0,0,0,0,1,0,e,r,t,1])}static Multiply(e,r,t=new l){const o=e.m[0],n=e.m[1],i=e.m[2],a=e.m[3],s=e.m[4],u=e.m[5],c=e.m[6],m=e.m[7],f=e.m[8],p=e.m[9],d=e.m[10],h=e.m[11],_=e.m[12],v=e.m[13],g=e.m[14],E=e.m[15],w=r.m[0],T=r.m[1],b=r.m[2],A=r.m[3],y=r.m[4],x=r.m[5],R=r.m[6],M=r.m[7],C=r.m[8],F=r.m[9],P=r.m[10],D=r.m[11],S=r.m[12],j=r.m[13],I=r.m[14],L=r.m[15];return t.m[0]=w*o+T*s+b*f+A*_,t.m[1]=w*n+T*u+b*p+A*v,t.m[2]=w*i+T*c+b*d+A*g,t.m[3]=w*a+T*m+b*h+A*E,t.m[4]=y*o+x*s+R*f+M*_,t.m[5]=y*n+x*u+R*p+M*v,t.m[6]=y*i+x*c+R*d+M*g,t.m[7]=y*a+x*m+R*h+M*E,t.m[8]=C*o+F*s+P*f+D*_,t.m[9]=C*n+F*u+P*p+D*v,t.m[10]=C*i+F*c+P*d+D*g,t.m[11]=C*a+F*m+P*h+D*E,t.m[12]=S*o+j*s+I*f+L*_,t.m[13]=S*n+j*u+I*p+L*v,t.m[14]=S*i+j*c+I*d+L*g,t.m[15]=S*a+j*m+I*h+L*E,t}multiply(e){return l.Multiply(this,e,this)}multiplyLeft(e){return l.Multiply(e,this,this)}position(){return[this.m[12],this.m[13],this.m[14]]}multiplyVector(e){const r=[0,0,0,0];for(let t=0;t<4;t++)for(let o=0;o<4;o++)r[t]+=this.m[4*o+t]*e[o];for(let e=0;e<3;e++)r[e]/=r[3];return r.pop(),r}inverse(){const e=this.m,r=e[0],t=e[1],o=e[2],n=e[3],i=e[4],a=e[5],s=e[6],u=e[7],c=e[8],m=e[9],f=e[10],p=e[11],d=e[12],h=e[13],_=e[14],v=e[15],g=f*v,E=_*p,w=s*v,T=_*u,b=s*p,A=f*u,y=o*v,x=_*n,R=o*p,M=f*n,C=o*u,F=s*n,P=c*h,D=d*m,S=i*h,j=d*a,I=i*m,L=c*a,U=r*h,N=d*t,O=r*m,B=c*t,X=r*a,k=i*t,V=g*a+T*m+b*h-(E*a+w*m+A*h),z=E*t+y*m+M*h-(g*t+x*m+R*h),Y=w*t+x*a+C*h-(T*t+y*a+F*h),G=A*t+R*a+F*m-(b*t+M*a+C*m),$=1/(r*V+i*z+c*Y+d*G);return new l([$*V,$*z,$*Y,$*G,$*(E*i+w*c+A*d-(g*i+T*c+b*d)),$*(g*r+x*c+R*d-(E*r+y*c+M*d)),$*(T*r+y*i+F*d-(w*r+x*i+C*d)),$*(b*r+M*i+C*c-(A*r+R*i+F*c)),$*(P*u+j*p+I*v-(D*u+S*p+L*v)),$*(D*n+U*p+B*v-(P*n+N*p+O*v)),$*(S*n+N*u+X*v-(j*n+U*u+k*v)),$*(L*n+O*u+k*p-(I*n+B*u+X*p)),$*(S*f+L*_+D*s-(I*_+P*s+j*f)),$*(O*_+P*o+N*f-(U*f+B*_+D*o)),$*(U*s+k*_+j*o-(X*_+S*o+N*s)),$*(X*f+I*o+B*s-(O*s+k*f+L*o))])}}class m{constructor(e,r){this.t=e,this.p=r}get position(){return this.t.matrix.multiply(this.p.inverse())}get matrix(){return this.position}get m(){return this.matrix.m}}class f{constructor(e=l.Identity(),r=l.Identity(),t=l.Identity(),o){this.shift=e,this.rotate=r,this.scale=t,this.parent=o}get position(){return(this.parent?.position||l.Identity()).multiply(this.shift).multiply(this.rotate)}get matrix(){return this.position.multiply(this.scale)}get m(){return this.matrix.m}}class p{constructor(e,r,t=[0,1,0]){this.parent=e,this.pos=r,this.up=t}get position(){return l.LookAt(this.pos,this.parent.matrix.position(),this.up)}get matrix(){return this.position}get m(){return this.matrix.m}}class d{constructor(e,r){this.material=e,this.transform=r}}class h{constructor(e,r,t){this.transform=e,this.color=r,this.size=t}}class _{constructor(e,r){this.meshes=e,this.drawers=r,this.models=i(e,(()=>new Array)),this.types=Object.keys(e)}add(e,r,t={}){const{x:o=0,y:n=0,z:i=0,angleX:a=0,angleY:s=0,angleZ:u=0,scale:c=1,parent:m}=t,p=new d(r,new f(l.Move(o,n,i),l.RotateX(a).multiply(l.RotateY(s)).multiply(l.RotateZ(u)),l.Scale(c),m));return this.models[e].push(p),p}draw(e,r,t){this.types.forEach((o=>{this.drawers[o].filter((({layers:e})=>e&t)).forEach((({draw:t})=>{t(e,r,this.meshes[o],this.models[o])}))}))}}class v{constructor(e){this.drawers=e,this.sprites=new Array,this.custom=new Array}addSprite(e,r,t={}){const{x:o=0,y:n=0,z:i=0,parent:a}=t,s=new h(new f(l.Move(o,n,i),l.Identity(),l.Identity(),a),r,e);return this.sprites.push(s),s}addCustom(e,r){return this.custom.push({layers:e,draw:r})}draw(e,r,t){this.sprites.forEach((o=>{this.drawers.sprite.filter((({layers:e})=>e&t)).forEach((({draw:t})=>{t(e,r,o)}))})),this.custom.filter((({layers:e})=>e&t)).forEach((({draw:t})=>t(e,r)))}}var g={};r(g,"simple",(()=>A)),r(g,"normalDebug",(()=>y)),r(g,"lightingProjector",(()=>x)),r(g,"shadowMap",(()=>R)),r(g,"sprite",(()=>M)),r(g,"texture",(()=>C));class E{constructor(e,{vertex:r,fragment:t},o,n){this.gl=e;try{this.program=function(e,r,t){const o=T(e,e.VERTEX_SHADER,r),n=T(e,e.FRAGMENT_SHADER,t),i=e.createProgram();if(e.attachShader(i,o),e.attachShader(i,n),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS))throw new Error(`Unable to initialize the shader program: ${e.getProgramInfoLog(i)}`);return i}(e,r,t),this.uniforms=function(e,r,t){return i(t,(t=>{const o=e.getUniformLocation(r,t);if(null===o)throw new Error(`Not found uniform ${t}`);return o}))}(e,this.program,o),this.attributes=function(e,r,t){return i(t,(t=>{const o=e.getAttribLocation(r,t);if(null===o)throw new Error(`Not found attribute ${t}`);return o}))}(e,this.program,n);const a=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS),s=new Set(Object.values(o));for(let r=0;r<a;++r){const{name:t,type:o}=e.getActiveUniform(this.program,r);s.has(t)||console.warn(`Not used uniform ${t} (${o}) in ${this.constructor.name}`)}const u=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES),c=new Set(Object.values(n));for(let r=0;r<u;++r){const{name:t,type:o}=e.getActiveAttrib(this.program,r);c.has(t)||console.warn(`Not used attribute ${t} (${o}) in ${this.constructor.name}`)}}catch(e){throw new Error(`Failed create program ${this.constructor.name}: ${e}`)}}}function w(e,r){const t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r),e.generateMipmap(e.TEXTURE_2D),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.bindTexture(e.TEXTURE_2D,null),t}function T(e,r,t){const o=e.createShader(r);if(!o)throw new Error(`Failed to compile the shader of type ${r}:\n${t}`);if(e.shaderSource(o,t),e.compileShader(o),!e.getShaderParameter(o,e.COMPILE_STATUS))throw new Error("An error occurred compiling the shaders: "+e.getShaderInfoLog(o));return o}var b;b="#version 300 es\nprecision mediump float;\n#define GLSLIFY 1\n\nuniform vec4 u_color;\nout vec4 FragColor;\n\nvoid main() {\n    FragColor = u_color;\n}";const A=r=>{const{program:t,uniforms:o,attributes:n}=new E(r,{vertex:e("#version 300 es\nprecision mediump float;\n#define GLSLIFY 1\n\nlayout(location = 0) in vec4 a_position;\nuniform mat4 u_transform;\nuniform mat4 u_projection;\nvoid main() {\n    gl_Position = u_projection * u_transform * vec4(a_position);\n}"),fragment:e(b)},{color:"u_color",transform:"u_transform",projection:"u_projection"},{position:"a_position"});return(e,n,i,a=!0,s=!1)=>{r.useProgram(t),r.bindVertexArray(n.vao);for(const t of i){const{diffuseColor:[i,u,c],debugColor:[l,m,f]=[i,u,c]}=t.material;r.uniformMatrix4fv(o.transform,!1,t.transform.m),r.uniformMatrix4fv(o.projection,!1,e.m),a&&(r.uniform4f(o.color,i,u,c,1),r.drawElements(r.TRIANGLES,n.indices.length,r.UNSIGNED_SHORT,0)),s&&(r.uniform4f(o.color,l,m,f,1),r.drawElements(r.LINES,n.indices.length,r.UNSIGNED_SHORT,0))}r.bindVertexArray(null),r.useProgram(null)}},y=r=>{const{program:t,uniforms:o,attributes:n}=new E(r,{vertex:e("#version 300 es\nprecision mediump float;\n#define GLSLIFY 1\n\nlayout(location = 0) in vec4 a_position;\nlayout(location = 1) in vec3 a_normal;\nuniform mat4 u_transform;\nuniform mat4 u_projection;\n\nout vec4 a_color;\nvoid main() {\n    gl_Position = u_projection * u_transform * vec4(a_position);\n    a_color = vec4(a_normal, 1);\n    a_color = vec4((a_color.x + 1.) / 2., (a_color.y + 1.) / 2., (a_color.z + 1.) / 2., a_color.w);\n}"),fragment:e("#version 300 es\nprecision mediump float;\n#define GLSLIFY 1\n\nin vec4 a_color;\nout vec4 FragColor;\n\nvoid main() {\n    FragColor = a_color;\n}")},{transform:"u_transform",projection:"u_projection"},{position:"a_position"});return(e,n,i)=>{r.useProgram(t),r.bindVertexArray(n.vao);for(const t of i)r.uniformMatrix4fv(o.transform,!1,t.transform.m),r.uniformMatrix4fv(o.projection,!1,e.m),r.drawElements(r.TRIANGLES,n.indices.length,r.UNSIGNED_SHORT,0);r.bindVertexArray(null),r.useProgram(null)}},x=r=>{const{program:t,uniforms:o,attributes:n}=new E(r,{vertex:e("#version 300 es\nprecision mediump float;\n#define GLSLIFY 1\n\nstruct Projector {\n    mat4 transform;\n    mat4 projection;\n    float angle;\n};\n\nlayout(location = 0) in vec4 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texcoord;\nuniform mat4 u_transform;\nuniform mat4 u_projection;\nuniform Projector u_projector;\nuniform vec3 u_viewPosition;\n\nout vec3 v_normal;\nout vec2 v_texcoord;\nout vec3 v_surfaceToLight;\nout vec3 v_surfaceToView;\nout vec4 v_shadowMapCoord;\nvoid main() {\n    vec4 position = u_transform * a_position;\n    gl_Position = u_projection * position;\n\n    v_texcoord = a_texcoord;\n    v_surfaceToLight = (u_projector.transform * vec4(0, 0, 0, 1)).xyz - position.xyz;\n    v_surfaceToView = u_viewPosition - position.xyz;\n    v_normal = mat3(u_transform) * a_normal;\n    v_shadowMapCoord = u_projector.projection * inverse(u_projector.transform) * position;\n}"),fragment:e("#version 300 es\nprecision mediump float;\nprecision mediump sampler2D;\nprecision mediump sampler2DShadow;\n#define GLSLIFY 1\n\nin vec3 v_normal;\nin vec3 v_surfaceToLight;\nin vec3 v_surfaceToView;\nin vec4 v_shadowMapCoord;\nin vec2 v_texcoord;\n\nstruct Material {\n    vec4 diffuseColor;\n    vec4 specularColor;\n    float specular;\n    bool hasTexture;\n};\n\nstruct Projector {\n    mat4 transform;\n    mat4 projection;\n    float angle;\n};\n\nuniform Material mat;\nuniform Projector u_projector;\nuniform sampler2DShadow shadowMap;\nuniform sampler2D textureSampler;\n\nout vec4 FragColor;\nvoid main() {\n    float l = length(v_surfaceToLight);\n    vec3 normal = normalize(v_normal);\n    vec3 surfaceToLightDirection = normalize(v_surfaceToLight);\n    vec3 surfaceToViewDirection = normalize(v_surfaceToView);\n    vec3 halfVector = normalize(surfaceToLightDirection + surfaceToViewDirection);\n\n    vec3 shadowMapCoord = v_shadowMapCoord.xyz / v_shadowMapCoord.w;\n    vec3 shadowCoords = (shadowMapCoord.xyz + vec3(1, 1, shadowMapCoord.z)) / 2.;\n    float inShadow = texture(shadowMap, shadowCoords);\n\n    float directionAngel = dot(surfaceToLightDirection, mat3(u_projector.transform) * vec3(0, 0, 1));\n    float inLight = smoothstep(cos(u_projector.angle / 2.), cos(0.), directionAngel);\n    float light = inLight * max(0.0, dot(normal, surfaceToLightDirection)) * 10. / (l * l);\n    float specular = inLight * pow(max(0.0, dot(normal, halfVector)), mat.specular);\n\n    vec3 diffuseColor = float(!mat.hasTexture) * mat.diffuseColor.rgb + float(mat.hasTexture) * texture(textureSampler, v_texcoord).rgb;\n    vec3 color = inShadow * (diffuseColor * light + mat.specularColor.rgb * specular);\n    FragColor = vec4(color, mat.diffuseColor.a);\n}")},{transform:"u_transform",projection:"u_projection",view:"u_viewPosition",diffuseColor:"mat.diffuseColor",specularColor:"mat.specularColor",specular:"mat.specular",enableTexture:"mat.hasTexture",texture:"textureSampler",projectorTransform:"u_projector.transform",projectorAngle:"u_projector.angle",projectorProjection:"u_projector.projection",shadowMap:"shadowMap"},{position:"a_position"}),i=r.createSampler();return r.samplerParameteri(i,r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE),r.samplerParameteri(i,r.TEXTURE_MAG_FILTER,r.LINEAR),r.samplerParameteri(i,r.TEXTURE_MIN_FILTER,r.LINEAR),(e,n,a,s,u,c)=>{r.useProgram(t),r.bindVertexArray(n.vao),r.bindSampler(10,i),r.uniformMatrix4fv(o.projection,!1,e.m),r.uniformMatrix4fv(o.projectorTransform,!1,s.transform.m),r.uniformMatrix4fv(o.projectorProjection,!1,s.projection.m),r.uniform1f(o.projectorAngle,s.angle),r.uniform3f(o.view,u[0],u[1],u[2]),r.uniform1i(o.shadowMap,c),n.texture&&(r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,n.texture),r.uniform1i(o.texture,1));for(const e of a)r.uniform1i(o.enableTexture,e.material.useTexture?1:0),r.uniformMatrix4fv(o.transform,!1,e.transform.m),r.uniform4f(o.diffuseColor,e.material.diffuseColor[0],e.material.diffuseColor[1],e.material.diffuseColor[2],1),r.uniform4f(o.specularColor,e.material.specularColor[0],e.material.specularColor[1],e.material.specularColor[2],1),r.uniform1f(o.specular,e.material.specular),r.drawElements(r.TRIANGLES,n.indices.length,r.UNSIGNED_SHORT,0);r.bindSampler(10,null),r.bindVertexArray(null),r.useProgram(null)}},R=r=>{const{program:t,uniforms:o,attributes:n}=new E(r,{vertex:e("#version 300 es\nprecision mediump float;\n#define GLSLIFY 1\n\nlayout(location = 0) in vec4 a_position;\n\nuniform mat4 u_transform;\nuniform mat4 u_projection;\n\nvoid main() {\n    vec4 position = u_transform * a_position;\n    gl_Position = u_projection * position;\n}"),fragment:e("#version 300 es\nprecision mediump float;\n#define GLSLIFY 1\n\nvoid main() {\n}")},{transform:"u_transform",projection:"u_projection"},{position:"a_position"});return(e,n,i)=>{r.useProgram(t),r.bindVertexArray(n.vao);for(const t of i)r.uniformMatrix4fv(o.transform,!1,t.transform.m),r.uniformMatrix4fv(o.projection,!1,e.m),r.drawElements(r.TRIANGLES,n.indices.length,r.UNSIGNED_SHORT,0);r.bindVertexArray(null),r.useProgram(null)}},M=r=>{const{program:t,uniforms:o,attributes:n}=new E(r,{vertex:e("#version 300 es\nprecision mediump float;\n#define GLSLIFY 1\n\nlayout(location = 0) in vec4 a_position;\nuniform mat4 u_transform;\nuniform mat4 u_projection;\nuniform float u_size;\n\nvoid main() {\n    gl_Position = u_projection * u_transform * vec4(a_position);\n    gl_PointSize = u_size;\n}"),fragment:e(b)},{color:"u_color",transform:"u_transform",projection:"u_projection",size:"u_size"},{position:"a_position"}),i=r.createBuffer();return(e,a,[s,u,c,m=1],f=16)=>{r.useProgram(t),r.uniform4f(o.color,s,u,c,m),r.uniformMatrix4fv(o.transform,!1,l.Identity().m),r.uniformMatrix4fv(o.projection,!1,e.m),r.uniform1f(o.size,f),r.bindBuffer(r.ARRAY_BUFFER,i),r.vertexAttribPointer(n.position,4,r.FLOAT,!1,0,0),r.bufferData(r.ARRAY_BUFFER,new Float32Array([...a,1]),r.STATIC_DRAW),r.enableVertexAttribArray(n.position),r.bindBuffer(r.ARRAY_BUFFER,null),r.drawArrays(r.POINTS,0,1),r.useProgram(null)}},C=e=>{const r=new E(e,{vertex:"#version 300 es\n        in vec2 position;\n        out vec2 v_texcoord;\n        void main() {\n        gl_Position = vec4(position, 0, 1);\n        v_texcoord = position.xy * 0.5 + 0.5;\n        v_texcoord.y = v_texcoord.y;\n    }",fragment:"#version 300 es\n        precision mediump float;\n        in vec2 v_texcoord;\n        uniform sampler2D tex;\n        out vec4 FragColor;\n        void main() {\n        FragColor = texture(tex, v_texcoord);\n    }"},{texture:"tex"},{position:"position"}),t=e.createVertexArray();e.bindVertexArray(t),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),e.STATIC_DRAW);const o=e.getAttribLocation(r.program,"position");return e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindVertexArray(null),o=>{e.useProgram(r.program),e.uniform1i(r.uniforms.texture,o),e.bindVertexArray(t),e.drawArrays(e.TRIANGLES,0,6),e.bindVertexArray(null),e.useProgram(null)}};class F{constructor(e,r,t,o,n,i){if(this.texture=n,r instanceof Float32Array)this.vertexes=r;else{this.vertexes=new Float32Array(4*r.length).fill(1);for(let e=0;e<r.length;e++)for(let t=0;t<3;t++)this.vertexes[4*e+t]=r[e][t]}t instanceof Uint16Array?this.indices=t:this.indices=new Uint16Array(t.flatMap((e=>e))),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,this.vertexes,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,4,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.indices,e.STATIC_DRAW),o&&(e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,3,e.FLOAT,!1,0,0)),i&&(e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i.flat()),e.STATIC_DRAW),e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,0,0)),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindVertexArray(null)}static Cube(e,r=1){const t=r/2,o=[[1,1,-1],[1,1,1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,-1],[-1,-1,1],[-1,1,1],[1,1,1],[1,1,-1],[-1,1,-1],[-1,-1,-1],[1,-1,-1],[1,-1,1],[-1,-1,1],[1,1,1],[-1,1,1],[-1,-1,1],[1,-1,1],[-1,1,-1],[1,1,-1],[1,-1,-1],[-1,-1,-1]].map((e=>e.map((e=>e*t))));return new F(e,o,[[0,1,2],[0,2,3],[4,5,6],[4,6,7],[8,9,10],[8,10,11],[12,13,14],[12,14,15],[16,17,18],[16,18,19],[20,21,22],[20,22,23]],[[1,0,0],[1,0,0],[1,0,0],[1,0,0],[-1,0,0],[-1,0,0],[-1,0,0],[-1,0,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,-1,0],[0,-1,0],[0,-1,0],[0,-1,0],[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0,0,-1],[0,0,-1],[0,0,-1],[0,0,-1]].flat())}static Camera(e,r=1){const t=[-1,-1,1,1,-1,1,-1,1,1,1,1,1,-1,-1,3,1,-1,3,-1,1,3,1,1,3,0,0,1],o=[0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,3,7,2,6],n=t.length/3,i=n-1;for(let e=0;e<6;++e){const r=e/6*Math.PI*2,a=Math.cos(r),s=Math.sin(r);t.push(a,s,0),o.push(i,n+e),o.push(n+e,n+(e+1)%6)}t.forEach(((e,o)=>{t[o]*=r}));const a=new Float32Array(t.length/3*4).fill(1);for(let e=0;e<t.length/3;e++)a[4*e+0]=t[3*e+0],a[4*e+1]=t[3*e+1],a[4*e+2]=t[3*e+2];return new F(e,a,new Uint16Array(o))}static DebugCube(e,r=1){const t=[-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1];t.forEach(((e,o)=>{t[o]*=r}));const o=new Float32Array(t.length/3*4).fill(1);for(let e=0;e<t.length/3;e++)o[4*e+0]=t[3*e+0],o[4*e+1]=t[3*e+1],o[4*e+2]=t[3*e+2];return new F(e,o,new Uint16Array([0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,3,7,2,6]))}static fromObj(e,r,t){const o=r.split(/\r\n/g),n=new Array,i=new Array,a=new Array,s=new Array,u=new Array,c=new Array,l=new Map;function m(e){const r=l.get(e);if(void 0!==r)return r;const[t,o,m]=e.split("/");s.push(n[+t-1]),u.push(i[+m-1]),c.push(a[+o-1]);const f=l.size;return l.set(e,f),f}const f=new Array;for(const e of o){if(""===e)continue;const[r,...t]=e.trim().split(/ +/g);if(r.startsWith("v")){const[e,o,s]=t;switch(r){case"v":n.push([+e,+o,+s]);break;case"vn":i.push([+e,+o,+s]);break;case"vt":a.push([+e,1-+o])}}else if("f"===r)for(let e=0;e<t.length-2;e++)f.push([m(t[0]),m(t[1+e]),m(t[2+e])])}return new F(e,s,f,u.flat(),w(e,t),c)}}let P;function D(e,r,t,o){const n=e/2,i=r/2,a=n/i,s={debug:[{viewport:[0,i,n,i],projection:l.Ortographic(-10,10,-10/a,10/a,100,-100),camera:new p(new f(l.Move(0,0,0)),[0,10,0],[0,0,-1]),layers:P.Special},{viewport:[n,0,n,i],projection:l.Perspective(Math.PI/4,n/i,.1,150),camera:t,layers:P.Main},{viewport:[n,i,n,i],projection:l.Perspective(Math.PI/4,n/i,.1,150),camera:t,layers:P.Main|P.DebugStroke},{viewport:[0,0,n,i],projection:o.projection,camera:o.transform,layers:P.Main}],half:[{viewport:[n,0,n,2*i],projection:l.Perspective(Math.PI/4,n/r,.1,150),camera:t,layers:P.Main},{viewport:[0,0,n,2*i],projection:l.Perspective(Math.PI/4,n/r,.1,150),camera:t,layers:P.Debug}],full:[{viewport:[0,0,e,r],projection:l.Perspective(Math.PI/4,e/r,.1,150),camera:t,layers:P.Main}]};let u={active:s.full,presets:s};{const e=[void 0,s.full,s.half,s.debug],r=[void 0,P.Main,P.Debug,P.DebugStroke|P.Main,P.Special];window.addEventListener("keydown",(t=>{if(!t.code.startsWith("Digit"))return;const o=Number(t.code.substring(5));t.shiftKey?u.active[0].layers=r[o]||u.active[0].layers:u.active=e[o]||u.active}));const{viewport:t}=function(e){const r=new URL(location.href);return Object.fromEntries(Object.entries(e).map((([e,t])=>[e,c(e,t,r.searchParams)])))}({viewport:1});u.active=e[t]||u.active}return u}!function(e){e[e.Main=1]="Main",e[e.DebugStroke=2]="DebugStroke",e[e.DebugFill=4]="DebugFill",e[e.Debug=6]="Debug",e[e.All=255]="All",e[e.Special=256]="Special"}(P||(P={}));class S{constructor(e,r,t){this.transform=e,this.angle=r,this.maxDistance=t,this.projection=l.Perspective(this.angle,1,.1,this.maxDistance)}}var j,I;(j={skull:"./skull.jpg"},I={skull:"./skull.obj"},Promise.all([a(j),u(I)]).then((([e,r])=>({images:e,files:r})))).then((({images:e,files:r})=>{const t=document.querySelector("canvas");t.width=t.clientWidth,t.height=t.clientHeight,document.body.appendChild(t);const o=t.getContext("webgl2");o.enable(o.DEPTH_TEST),o.enable(o.CULL_FACE),o.blendFunc(o.SRC_ALPHA,o.ONE);const n=i(g,(e=>{try{return e(o)}catch(r){throw new Error(`Failed init Drawer.${e.name}: ${r}`)}})),a={layers:P.Main,draw:(e,r,t,o)=>n.lightingProjector(e,t,o,w,r.position(),10)},s={layers:P.DebugStroke,draw:(e,r,t,o)=>n.simple(e,t,o,!1,!0)},u={layers:P.DebugFill,draw:(e,r,t,o)=>n.normalDebug(e,t,o)},c=new _({cube:F.Cube(o),debugCube:F.DebugCube(o),camera:F.Camera(o),skull:F.fromObj(o,r.skull,e.skull)},{cube:[a,s,u],skull:[a,s,u],camera:[{layers:P.Debug,draw:(e,r,t,o)=>n.simple(e,t,o,!1,!0)}],debugCube:[{layers:P.Debug,draw:(e,r,t,o)=>n.simple(e,t,o,!1,!0)}]}),d=new v({sprite:[{layers:P.All,draw:(e,r,t)=>n.sprite(e,t.transform.matrix.position(),t.color,t.size)}]});c.add("cube",{diffuseColor:[.8,.8,.8],specularColor:[1,1,1],specular:100},{scale:10,x:2,y:-7}),c.add("cube",{diffuseColor:[0,1,0],specularColor:[1,1,1],specular:100},{scale:1,x:1,y:-.5});const h=c.add("cube",{diffuseColor:[0,0,1],specularColor:[1,1,1],specular:100},{scale:1,x:5,y:.5});c.add("cube",{diffuseColor:[1,0,0],specularColor:[1,1,1],specular:100},{scale:1,x:3,y:.5}),c.add("cube",{diffuseColor:[.8,.8,.8],specularColor:[1,1,0],specular:100},{scale:20,x:17.5,y:.5});const E=new f(l.Move(-4.5,.5,-4),l.RotateY(5*Math.PI/4));c.add("skull",{diffuseColor:[1,.5,.5],specularColor:[.5,1,1],specular:1e3,debugColor:[0,0,1],useTexture:!0},{scale:.05,x:3,y:-1,z:-2,angleX:-Math.PI/2,angleZ:-Math.PI/2}),c.add("skull",{diffuseColor:[1,.2,0],specularColor:[.5,1,1],specular:1e3,debugColor:[0,0,1],useTexture:!1},{scale:.01,angleX:-Math.PI/2,angleZ:Math.PI,parent:new p(E,[3,1,0],[0,1,0])});const w=new S(new p(h.transform,[0,0,0]),Math.PI/2,1e5);c.add("skull",{diffuseColor:[1,.5,.5],specularColor:[.5,1,1],specular:1e3,debugColor:[0,0,1],useTexture:!0},{scale:.02,x:0,y:0,z:0,angleX:-Math.PI/2,angleZ:Math.PI,parent:new p(w.transform,[1,0,0],[0,1,0])}),d.addSprite(16,[.5,.5,0],{parent:w.transform}),d.addCustom(P.Special,(()=>n.texture(10)));const T=l.Perspective(Math.PI/4,t.width/t.height,.1,150);!function(e,r,t){e.add("camera",{diffuseColor:[0,0,0],debugColor:[1,1,1],specular:0,specularColor:[0,0,0]},{scale:.1,parent:r}),e.add("debugCube",{diffuseColor:[0,0,0],debugColor:[1,1,1],specular:0,specularColor:[0,0,0]},{parent:new m(r,t)})}(c,E,T),c.add("debugCube",{diffuseColor:[0,0,0],debugColor:[1,1,0],specular:0,specularColor:[0,0,0]},{parent:new m(w.transform,w.projection)});const b=D(t.width,t.height,E,w);let A=0,y=-1,x=0;const R=new L,M=function(e,r,t){const o=e.createTexture(),n=1024,i=g.shadowMap(e);e.bindTexture(e.TEXTURE_2D,o),e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT32F,n,n,0,e.DEPTH_COMPONENT,e.FLOAT,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const a=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,a),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,o,0),{texture:o,updator:o=>{e.bindFramebuffer(e.FRAMEBUFFER,a),e.viewport(0,0,n,n),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const s=l.Multiply(o.projection,o.transform.matrix.inverse());t.forEach((e=>{i(s,r.meshes[e],r.models[e])})),e.bindFramebuffer(e.FRAMEBUFFER,null)}}}(o,c,["cube","skull"]),C=e=>{const r=(e-A)/1e3;x+=r,A=e;const t=[1,-.5,0];if(t[0]+=3*Math.cos(x/2),t[1]+=.5*Math.cos(x/2),t[2]+=3*Math.sin(x/2),w.transform.pos=t,R.totalPressed>0){let[e,t,o]=R.moveDirection(r);const n=R.keys.speed?4:1;[e,t,o]=E.rotate.multiplyVector([e,t,o,1]),E.shift.multiply(l.Move(e*n,t*n,o*n));const[i,a,s]=R.rotateDirection(r);E.rotate.multiply(l.RotateX(i).multiply(l.RotateY(a)))}M.updator(w),o.activeTexture(o.TEXTURE10),o.bindTexture(o.TEXTURE_2D,M.texture),o.clearColor(.1,.1,.1,1),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),b.active.forEach((e=>{o.viewport(...e.viewport);const r=e.camera.matrix,t=l.Multiply(e.projection,r.inverse());c.draw(t,r,e.layers),d.draw(t,r,e.layers)})),o.activeTexture(o.TEXTURE10),o.bindTexture(o.TEXTURE_2D,null),y=requestAnimationFrame(C)};y=requestAnimationFrame(C)}));class L extends class{totalPressed=0;constructor(e,r=window){const t=Object.values(e);this.keys=Object.fromEntries(t.map((e=>[e,!1]))),r.addEventListener("keydown",(r=>{const t=e[r.code];t&&(r.preventDefault(),this.keys[t]||(this.keys[t]=!0,++this.totalPressed))})),r.addEventListener("keyup",(r=>{const t=e[r.code];t&&(r.preventDefault(),this.keys[t]&&(this.keys[t]=!1,--this.totalPressed))}))}}{constructor(){super({KeyW:"forward",KeyS:"backward",KeyA:"left",KeyD:"right",Space:"up",KeyV:"down",KeyF:"turnDown",KeyR:"turnUp",KeyQ:"turnRight",KeyE:"turnLeft",ShiftLeft:"speed"})}moveDirection(e){const{left:r,right:t,up:n,down:i,forward:a,backward:s}=this.keys;return o.Normilize([+t-+r,+n-+i,+s-+a],e)}rotateDirection(e){const{turnDown:r,turnLeft:t,turnRight:n,turnUp:i}=this.keys;return o.Normilize([+i-+r,+n-+t,0],e)}}
//# sourceMappingURL=index.2721e9cd.js.map
